{
  "Parameters": {
    "DeploymentId": {
      "Type": "string"
    },
    "SubscriptionName": {
      "Type": "string"
    },
    "AzureKeyVaultName": {
      "Type": "string"
    }
  },
  "Modules": [
    "SitecoreInstallAzure",
    "SitecoreInstallExtensions"
  ],
  "Variables": {
    "SitecoreAdminPassword": "[password('8')]",
    "SqlAdminPassword": "[password('16')]",
    "EXMCryptographicKey": "[randomHex('32')]",
    "EXMAuthenticationKey": "[randomHex('32')]",
    "SecretFromKeyVault": "[getsecret(parameter('AzureKeyVaultName'),'SitecoreAdminPassword') ]"
  },
  "Tasks": {
    "Login": {
      // Login to Azure account
      "Type": "AzureLogin",
      "Params": {
        "AzureSubscription": "[parameter('SubscriptionName')]"
      }
    },
    "DisplayVariable": {
      "Type": "ScriptBlock",
      "Params": {
        "Script": "PARAM($Message,$Tag) Write-TaskInfo -Message $Message -Tag $Tag",
        "Arguments": [ "[variable('SecretFromKeyVault')]", "ScriptBlock" ]
      }
    },
    "Save-SitecoreAdminPassword": {
      "Type": "SetSecret",
      "Params": {
        "VaultName": "[parameter('AzureKeyVaultName')]",
        "SecretName": "[concat('SitecoreAdminPassword-', parameter('DeploymentId'))]",
        "SecretValue": "[variable('SitecoreAdminPassword')]",
        "Tags": {
          "Sitecore": "9",
          "Test": "true"
        }
      }
    },
    "Save-SqlAdminPassword": {
      "Type": "SetSecret",
      "Params": {
        "VaultName": "[parameter('AzureKeyVaultName')]",
        "SecretName": "[concat('SqlAdminPassword-', parameter('DeploymentId'))]",
        "SecretValue": "[variable('SqlAdminPassword')]"
      }
    }
  }
}